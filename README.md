# MAControls / MAMSHFlexGridEx

**MAControls** — это COM/ActiveX DLL (ATL), которая добавляет “умное” редактирование к классическому `MSHFlexGrid` (MSHFLXGD.OCX):  
вместо встроенного редактора ячейки используется внешний редактор, которым можно управлять из кода (на уровне ячейки/колонки/строки), плюс есть управляемая навигация при выходе из редактирования.

## Коротко (для GitHub About)
ActiveX/ATL обёртка над MSHFlexGrid с настраиваемым внешним редактированием ячеек (popup TextBox и MSForms ComboBox) и управляемой навигацией.

---

## Что внутри

DLL регистрирует два контрола:

- **`C935_Gen34.MA_MSHFlexGridEx`** — основной контрол-обёртка над `MSHierarchicalFlexGridLib.MSHFlexGrid`.
- **`C935_Gen34.MA_ComboBoxEx`** — вспомогательный контрол-обёртка над `MSForms.ComboBox` (используется как оверлей-редактор для combo/list ячеек).

## Основная идея

1) Внутри `MAMSHFlexGridEx` создаётся настоящий `MSHFlexGrid` в `CAxWindow` (`m_axGrid`).  
2) Встроенное редактирование у грида выключается (`Editable=0`).  
3) Когда пользователь инициирует редактирование, контрол показывает **внешний редактор**:
   - **Текстовая ячейка** → Win32 `EDIT` в небольшом **popup-окне** (может быть multiline).
   - **Combo/List ячейка** → ActiveX `MA_ComboBoxEx`, который хостит `MSForms.ComboBox` поверх клетки.

4) После commit:
   - значение записывается в `TextMatrix(row,col)` грида,
   - выполняется (опционально) **навигация** (Tab/стрелки/и т.п.),
   - фокус возвращается в “реальное” внутреннее окно грида (важно для VB6/ThunderForm).

---

## Возможности

### Редактирование (Level-A)
- Типы ячеек:
  - `maCellText` — текст (popup Win32 EDIT).
  - `maCellCombo` — список + свободный ввод (MSForms ComboBox).
  - `maCellList` — только список (DropDownList).
  - `maCellReadOnly` — редактирование запрещено.
- Настройка **дефолта**, **по колонке**, **по строке/ячейке** (ячейка имеет приоритет над колонкой/дефолтом).
- Установка списка значений для combo/list через `SetCellItems`/`SetColumnItems`/`SetDefaultCellItems`.
- В popup-текстовом редакторе:
  - ширина окна редактора (`TextEditWidthPx`, 0 = ширина клетки),
  - multiline (`TextEditMultiline`),
  - видимое число строк (`TextEditVisibleLines`).

### Навигация (Level-B)
Можно настроить, что делать **после выхода из редактирования**:
- какие клавиши считаются “выходом” (маска `MANavExitKeys`),
- wrap на Tab/Shift+Tab,
- пропуск read-only/фиксированных областей,
- авто-начало редактирования после перемещения (опционально).

### Прямой доступ к исходному MSHFlexGrid
`IMAMSHFlexGridEx::Grid` возвращает `IDispatch` внутреннего MSHFlexGrid — можно вызывать любые свойства/методы оригинального контрола (Rows/Cols/TextMatrix/TopRow/ColWidth и т.д.), не дублируя весь API в обёртке.

---

## Ограничения и важные замечания

1) **Windows-only** (COM/ActiveX, ATL).
2) Требуются внешние зависимости:
   - `MSHFLXGD.OCX` (**Microsoft Hierarchical FlexGrid**) должен быть установлен/зарегистрирован.
   - `MSForms.ComboBox` (`Forms.ComboBox.1`, обычно `FM20.DLL`) должен быть доступен в системе.
3) Практически всегда это история про **32-bit** (VB6/старые OCX).  
   Теоретически код можно собрать под x64, но зависимости (`MSHFLXGD.OCX`, `FM20.DLL`) часто недоступны в 64-bit вариантах.
4) Лицензирование/распространение зависимостей:
   - Проект **не поставляет** `MSHFLXGD.OCX` и `FM20.DLL` и не снимает вопросы их лицензирования.
5) UI/фокус в хостах:
   - В VB6/ThunderForm фокус может “прыгать” на контейнер, поэтому в проекте есть отложенный `PostFocusGrid()` — если хост ведёт себя нестандартно, возможно потребуется включить диагностику фокуса.

---

## Сборка

### Требования
- Visual Studio (MSVC) с поддержкой **ATL**.
- Windows SDK.
- Сборка под Win32 (рекомендуется).

### Сборка
Открыть решение/проект в Visual Studio и собрать конфигурацию `Release|Win32` (или `Debug|Win32`).

---

## Регистрация (COM)

После сборки зарегистрируйте DLL:

```bat
regsvr32 MAControls.dll

Copyright Kolobov Aleksei 2026 telegram: @kilax9276
